<!DOCTYPE html>
<html>
<head lang="hr">
    <meta charset="UTF-8">
    <title>Acme Product Management</title>

    <!-- Style sheets -->
    <link href="Content/bootstrap.css" rel="stylesheet" />
    <link href="Scripts/datatables/datatables.css" rel="stylesheet" />
    <!--<link href="Scripts/semantic/semantic.css" rel="stylesheet" />-->

</head>
<body>

    <script src="Scripts/jquery-3.2.1.js"></script>
    <!--<script src="Scripts/semantic/semantic.js"></script>-->
    <script src="Scripts/bootstrap.js"></script>
    <script type="text/javascript" src="Scripts/vue.min.js"></script>
    <script type="text/javascript" src="Scripts/axios.min.js"></script>

    <script src="Scripts/component/datatables.js"></script>


    <script src="Scripts/component/bs_combo_box.js"></script>
    <script src="Scripts/component/bs_combo_cost_type.js"></script>
    <script src="travel/dataRepository.js"></script>


    <div id="travel">
        <div class="container">
            <form class="form-inline">
                <h1>Službeno putovanje</h1>
                <div style="padding-bottom:5px;">
                    <div class="form-group"><input class="form-control" type="datetime-local" v-model:date="order.travel_date" /></div>
                    <div class="form-group"><town-select label="u" v-model="order.town_to" /></div>
                </div>
                <ul class="nav nav-tabs">
                    <li class="active"><a data-toggle="tab" href="#relation_tab">Relacije</a></li>
                    <li><a data-toggle="tab" href="#cost_tab">Troškovi</a></li>
                    <li><a data-toggle="tab" href="#">Obračun</a></li>
                </ul>

                <div class="tab-content">
                    <div class="tab-pane active" id="relation_tab">

                        <div class="form" style="margin-top:1em;">
                            <div class="form-group"><town-select v-model="rel_town_from" /></div>
                            <div class="form-group"><town-select label="-" v-model="rel_town_to" /></div>
                            <div class="form-group"><input type="number" class="form-control text-right" style="width:7em;" v-model:number="rel_km" /></div>
                            <div class="btn btn-primary" @click="addRoute"><span class="glyphicon glyphicon-plus"></span></div>
                        </div>

                        <table id="route_table" class="table table-striped table-bordered table-hover" cellspacing="0" width="100%">
                            <thead>
                                <tr>
                                    <th>Polazište</th>
                                    <th>Odredište</th>
                                    <th width="20%">Kilometara</th>
                                    <th width="20%">Iznos</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="r in this.order.relations">
                                    <td>{{r.town_from.name}}</td>
                                    <td>{{r.town_to.name}}</td>
                                    <td class="text-right">{{r.km}}</td>
                                    <td class="text-right">{{r.amount}}</td>
                                </tr>
                            </tbody>
                            <tfoot>
                                <tr>
                                    <th>Ukupno</th>
                                    <th></th>
                                    <th class="text-right">{{this.order.total_km}}</th>
                                    <th class="text-right">{{this.order.total_km_amount}}</th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    <div class="tab-pane" id="cost_tab">

                        <div class="form" style="margin-top:1em;">
                            <div class="form-group"><cost-type-select v-model="selected_cost_type_id" /></div>
                            <div class="form-group"><input class="form-control" type="text" v-model="cost_description" /></div>
                            <div class="form-group"><input class="form-control text-right" type="number" v-model="cost_qty" /></div>
                            <div class="form-group"><input class="form-control text-right" type="number" v-model="cost_unit_price" /></div>
                            <div class="btn btn-primary" @click="addCost"><span class="glyphicon glyphicon-plus"></span></div>
                        </div>

                        <table id="cost_table" class="table table-striped table-bordered table-hover" cellspacing="0" width="100%">
                            <thead>
                                <tr>
                                    <th width="60%">Opis</th>
                                    <th width="15%">Količina</th>
                                    <th width="15%">Cijena</th>
                                    <th width="15%">Iznos</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="r in this.order.costs">
                                    <td class="text-left">{{r.description}}</td>
                                    <td class="text-right">{{r.qty}}</td>
                                    <td class="text-right">{{r.unit_price}}</td>
                                    <td class="text-right">{{r.amount}}</td>
                                </tr>
                            </tbody>
                            <tfoot>
                                <tr>
                                    <th>Ukupno</th>
                                    <th></th>
                                    <th></th>
                                    <th class="text-right">{{this.order.total_costs}}</th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script type="text/javascript">

        $(document).ready(function () {

            var route_table = $('#route_table').DataTable({
                "paging": false,
                "ordering": false,
                "info": false,
                "sorting": false,
                "searching": false,
            });

            $('#route_table tbody').on('click', 'tr', function () {
                if ($(this).hasClass('bg-primary')) {
                    $(this).removeClass('bg-primary');
                }
                else {
                    route_table.$('tr.bg-primary').removeClass('bg-primary');
                    $(this).addClass('bg-primary');
                }
            });

       /*     $('#route_table').click(function () {
                route_table.row('.selected').remove().draw(false);
            });*/


        });

        var travel = new Vue({
            el: "#travel",
            data: {
                order: null,
                rel_town_from: null,
                rel_town_to: null,
                visible_tab: 2,
                rel_km: 0.0,
                total_km: 0.0,

                cost_description: "",
                selected_cost_type_id:0,
                cost_unit_price: 0.0,
                cost_qty: 1.0,
            },
            beforeMount: function () {
                this.order = init_order;
            },
            mounted: function () {
              

                $('#cost_table').DataTable({
                    "paging": false,
                    "ordering": false,
                    "info": false,
                    "sorting": false,
                    "searching": false,
                    "selecting": true
                });

                this.sumKm();
                this.sumCosts()
            },
            methods: {
                setVisibleTab: function (tab) {
                    visible_tab = tab;
                },
                sumCosts: function () {

                    this.total_costs = 0.0;

                    for (i in this.order.costs) {
                        this.order.total_costs += this.order.costs[i].amount;
                    }
                },
                sumKm: function () {

                    this.order.total_km = 0;
                    this.order.total_km_amount = 0;

                    for (i in this.order.relations) {
                        this.order.total_km += this.order.relations[i].km;
                        this.order.relations[i].amount = this.order.relations[i].km * unit_km_amount;
                        this.order.total_km_amount += this.order.relations[i].amount;
                    }

                    this.order.total_km_amount = this.order.total_km_amount * unit_km_amount;
                },
                addCost() {
                    let data = { "description": "", "qty": 1, "unit_price": 0.0, "amount": 0.0 };

                    data.unit_price = this.cost_unit_price;
                    data.qty = this.cost_qty;
                    data.description = this.cost_description;
                    data.amount = Number(data.unit_price) * Number(data.qty);

                    this.order.costs.push(data);

                    this.sumCosts()
                },
                addRoute() {

                    let data = {
                        "town_from": null,
                        "town_to": null,
                        "km": Number(this.rel_km),
                        "amount": 0.0
                    };

                    data.town_from = this.getTownById(this.rel_town_from);
                    data.town_to = this.getTownById(this.rel_town_to);

                    this.order.relations.push(data);

                    this.sumKm();

                    $('#route_table').DataTable();

                },
                getTownById: function (town_id) {

                    let town = null;

                    $(towns).each(function (index, data) {
                        if (data.id == town_id) {
                            town = data;
                        }
                    });
                    return town;
                }
            }

        });

    </script>

</body>

</html>